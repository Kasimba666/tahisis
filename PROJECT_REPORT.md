# Отчёт о проделанной работе: Веб-приложение Tahisis

## Общее назначение

**Tahisis** — это специализированное веб-приложение для исторических исследований, предназначенное для работы с данными ревизских сказок (переписей населения) Российской империи. Приложение обеспечивает комплексный анализ, визуализацию и экспорт демографических и сословных данных с использованием современных картографических технологий.

## Технологический стек

### Frontend
- **Vue 3** (Options API) — основной JavaScript-фреймворк
- **Element Plus** — библиотека UI-компонентов
- **SCSS** — препроцессор CSS
- **Vite** — сборщик и dev-сервер
- **Yarn** — менеджер пакетов

### Картография
- **Leaflet** — библиотека для интерактивных карт
- **OpenLayers** — альтернативная библиотека карт
- Поддержка GeoJSON для векторных данных

### Backend & Database
- **Supabase** — Backend-as-a-Service платформа
- **PostgreSQL** — реляционная база данных

### Дополнительные библиотеки
- **XLSX** — экспорт данных в Excel
- **Puppeteer** — автоматизация браузера (опционально)

## Архитектура базы данных

### Основные таблицы
1. **District** — административные районы
2. **Settlement** — населённые пункты (с координатами)
3. **Revision_report** — данные ревизий
4. **Report_record** — записи переписи населения
5. **Estate** — сословные данные
6. **Type_estate** — типы сословий
7. **Subtype_estate** — подтипы сословий (с цветовой маркировкой)
8. **Type_religion** — типы религий
9. **Type_affiliation** — типы принадлежности
10. **Volost** — волости
11. **Landowner** — помещики
12. **Military_unit** — войсковые организации
13. **Vector_layer** — векторные картографические слои
14. **Type_vector_layer** — типы векторных слоёв

## Основные функциональные возможности

### 1. Система навигации и страницы

#### Главная страница (/)
- Обзор системы и начальная точка

#### Населённые пункты (/settlements)
- Отображение списка населённых пунктов
- Фильтрация по районам, типам сословий, ревизиям
- Картографическая визуализация с маркерами
- Экспорт данных в Excel
- Режимы просмотра: список, карта, split-режим, GeoJSON

#### Сословия (/estates)
- Детальный анализ сословных групп
- Иерархическая структура: типы → подтипы
- Цветовая кодировка на карте
- Демографическая статистика

#### Типы сословий (/estate-types)
- Управление типами сословий
- CRUD операции
- Цветовая схематика

#### Типы сословий по населённым пунктам (/estates-by-type)
- Анализ распределения сословий
- Географическая привязка

#### Загрузка ревизий (/revisions-upload)
- Импорт данных ревизий из Excel
- Валидация и обработка

#### Векторные слои (/vector-layers)
- Управление картографическими слоями
- Загрузка GeoJSON файлов
- Настройка стилей отображения

#### Типы векторных слоёв (/vector-layer-types)
- Категоризация векторных слоёв

#### Настройки (/settings)
- Конфигурация приложения
- Управление темами
- Экспорт/импорт настроек

#### О проекте (/about)
- Информация о приложении

### 2. Система фильтрации

#### Многокритериальная фильтрация
- **Ревизии** — выбор одной или нескольких переписей
- **Географические фильтры**:
  - Районы
  - Населённые пункты (старые и современные названия)
- **Сословные фильтры**:
  - Типы сословий
  - Подтипы сословий
  - Религии
  - Принадлежности
- **Административные фильтры**:
  - Волости
  - Помещики
  - Войсковые организации
- **Демографические фильтры**:
  - Диапазоны численности мужчин
  - Диапазоны численности женщин
  - Общая численность населения
  - Количество сословий (для режима report)

#### Интерфейс фильтров
- Dropdown-меню с поиском
- Чекбоксы для множественного выбора
- Активные фильтры отображаются в виде тегов
- Возможность удаления отдельных фильтров
- Сохранение фильтров в URL и localStorage
- Получение shareable-ссылок с фильтрами

### 3. Картографическая визуализация

#### Двойная картографическая система
- **Leaflet** — основная карта
- **OpenLayers** — альтернативная карта
- Переключение между картами
- Синхронизация положения и масштаба

#### Маркеры населённых пунктов
- **Концентрические круги** — отображение сословного состава
- **Цветовая кодировка** — каждое сословие имеет свой цвет
- **Размер маркера** — зависит от численности населения
- **Интерактивные tooltips** — название и район при наведении
- **Popups** — детальная информация при клике
- **Pie-маркеры** — для населённых пунктов с несколькими сословиями

#### Векторные слои
- Загрузка и отображение GeoJSON
- Настройка стилей (цвет, толщина линий, прозрачность)
- Управление видимостью слоёв
- Tooltips с названием слоя при наведении
- Поддержка различных геометрий: Point, LineString, Polygon, MultiPoint, MultiLineString, MultiPolygon

#### Функции управления картой
- **Home button** — возврат к исходному виду
- **Fullscreen режим** — полноэкранное отображение
- **Автоматическая легенда** — показывает активные типы сословий
- **Раскрывающаяся легенда** — в fullscreen режиме показывает все элементы
- **Выделение на карте** — пульсирующий круг при показе объекта

### 4. Режимы отображения данных

#### ViewMode Selector
- **List** — табличное представление
- **Map** — только карта
- **Split** — таблица и карта одновременно
- **GeoJSON** — просмотр сырых GeoJSON данных

### 5. Экспорт данных

#### Excel экспорт
- Экспорт отфильтрованных данных
- Форматированные таблицы с заголовками
- Итоговые строки с суммами
- Информация о примененных фильтрах
- Автоматическая генерация имени файла с датой

#### GeoJSON экспорт
- Экспорт географических данных
- Сохранение метаданных
- Совместимость со стандартом GeoJSON

### 6. Детальные представления

#### Детали населённого пункта
- Полная демог

рафическая информация
- Список ревизий с данными
- Детализация по сословиям
- Встроенная карта с позицией
- Кнопка "Показать на карте"

#### Детали сословия
- Карточка подтипа сословия
- Распределение по населённым пунктам
- Статистика по ревизиям

### 7. Система тем

#### Темная и светлая темы
- Переключение между темами
- CSS переменные для всех цветов
- Адаптация всех компонентов
- Сохранение выбора в localStorage

#### Цветовые схемы
- Настройка акцентных цветов
- Предустановленные палитры
- Custom цветовая схема

### 8. Адаптивный дизайн

#### Responsive layout
- Поддержка desktop (1920px+)
- Tablet режим (768px-1024px)
- Mobile режим (<768px)
- Адаптивные таблицы
- Компактный интерфейс
- Минимальные отступы согласно требованиям

### 9. Производительность и оптимизация

#### Ленивая загрузка
- Динамический импорт компонентов
- Загрузка данных по требованию
- Виртуализация больших списков

#### Кэширование
- localStorage для настроек
- URL параметры для состояния
- Сохранение состояния фильтров

#### Оптимизация запросов
- Серверная фильтрация через Supabase
- Агрегация данных на сервере
- Минимизация количества запросов

### 10. Управление состоянием

#### Vuex Store модули
- **auth** — аутентификация пользователей
- **mapSettings** — настройки карт
- **mapView** — состояние просмотра карты
- **pageState** — состояние страниц (viewMode, etc.)

#### Composables
- **useMapMarkers** — утилиты для маркеров
- **useScreen** — адаптивность экрана
- **useStorage** — работа с localStorage
- **useTableSorting** — сортировка таблиц
- **useEstatesFilters** — управление фильтрами

### 11. Загрузка данных

#### Excel импорт
- Загрузка типов сословий
- Импорт ревизских данных
- Валидация формата
- Обработка больших файлов

#### Векторные данные
- Загрузка GeoJSON файлов
- Автоматическое определение CRS
- Подсчёт features
- Определение bbox

### 12. Служебные функции

#### Работа с данными
- Форматирование чисел (русская локаль)
- Конвертация GeoJSON
- Группировка и агрегация
- Сортировка кириллицы

#### Утилиты
- Генерация shareable ссылок
- Копирование в буфер обмена
- Обработка координат
- HSL цветовые функции

## Структура проекта

```
tahisis/
├── public/                    # Статические файлы
│   └── assets/               # Изображения, иконки
├── scripts/                  # Python скрипты
├── src/
│   ├── assets/              # Vue assets
│   ├── components/          # Vue компоненты
│   │   ├── maps/           # Картографические компоненты
│   │   │   ├── LeafletMap.vue
│   │   │   └── OpenLayersMap.vue
│   │   ├── EstatesFilters.vue
│   │   ├── EstatesListAndMap.vue
│   │   ├── SettlementsListAndMap.vue
│   │   ├── MapView.vue
│   │   ├── MapLegend.vue
│   │   ├── VectorLayersControl.vue
│   │   └── ...
│   ├── composables/         # Composable функции
│   ├── layout/              # Компоненты layout
│   ├── pages/               # Страницы приложения
│   ├── router/              # Vue Router
│   ├── services/            # API сервисы
│   ├── store/               # Vuex store
│   ├── styles/              # Глобальные стили
│   │   ├── main.scss
│   │   ├── themes.scss
│   │   └── variables.scss
│   ├── App.vue
│   └── main.js
├── .clinerules/             # Правила разработки
├── package.json
├── vite.config.js
└── yarn.lock
```

## Особенности реализации

### 1. Стилистические конвенции
- **camelCase** для JavaScript переменных
- **kebab-case** для CSS классов и компонентов
- **PascalCase** для имён файлов компонентов
- Все async вызовы через `.then().catch()`
- Scoped стили в компонентах

### 2. Порядок секций в компонентах
```vue
<template>...</template>
<script>
  export default {
    name: '...',
    props: {},
    data() {},
    computed: {},
    methods: {},
    watch: {}
  }
</script>
<style scoped lang="scss">...</style>
```

### 3. Цветовая система
- Все цвета в HSL формате
- CSS переменные для динамической смены темы
- Система data-theme атрибута на html/body

### 4. Компактный интерфейс
- Минимальные paddings (2-4px)
- Плотное размещение элементов
- Оптимизация использования пространства
- Адаптивные скроллбары

## Реализованные улучшения

### Последние доработки
1. **Tooltips для векторных слоёв** — при наведении показывается название слоя
2. **Fullscreen legend** — автоматическое раскрытие легенды в полноэкранном режиме
3. **Фикс фильтров** — исправлена ошибка с Promise в методе applyFiltersAndLoad
4. **Обработка событий fullscreen** — правильная обработка в обеих картографических библиотеках

## Безопасность и аутентификация

- Интеграция с Supabase Auth
- Row Level Security (RLS) в базе данных
- Ограничение доступа к операциям
- Валидация на клиенте и сервере

## Развёртывание

### Development
```bash
yarn install
yarn dev
```

### Production Build
```bash
yarn build
```

### Environment Variables
```
VITE_SUPABASE_URL=...
VITE_SUPABASE_ANON_KEY=...
```

## Заключение

Веб-приложение **Tahisis** представляет собой современное решение для работы с историческими демографическими данными. Оно объединяет мощные инструменты фильтрации, визуализации и анализа с интуитивным пользовательским интерфейсом и профессиональными картографическими возможностями.

Основные достижения проекта:
- ✅ Комплексная система фильтрации с 10+ параметрами
- ✅ Двойная картографическая система (Leaflet + OpenLayers)
- ✅ Интерактивные маркеры с детальной информацией
- ✅ Работа с векторными слоями и GeoJSON
- ✅ Экспорт в Excel с форматированием
- ✅ Адаптивный дизайн и темная/светлая темы
- ✅ Оптимизированная производительность
- ✅ Полная типизация данных
- ✅ Система состояния с Vuex
- ✅ URL-based навигация и фильтрация

Проект готов к использованию исследователями для глубокого анализа ревизских сказок и демографических процессов Российской империи.
